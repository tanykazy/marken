<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>意味順</title>
<style>
.container{
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}

#originalTxt{
  display:inline-block;
  overflow-wrap: anywhere;
  width:80%;
  height: 300px;  
}

#btn{
  display:inline-block;
  width:80%;
  height: 50px;
  font-size: 20px;
}

#english{
    /* 行間 */
    line-height: 250%;
    /* 文字の大きさ */
    font-size: 1.5em;
    /* 文字折り返し */
    overflow-wrap: normal;
}

[data-ruby] {
    position: relative;
}
[data-ruby]::before {
    content: attr(data-ruby);
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    margin: auto;
    font-size: 13px;
}
</style>
</head>
<body>
<div class="container">
  
<!-- 英文の貼り付け場所 -->
<textarea id="originalTxt"></textarea>

<br>

<!-- ボタン -->  
<button id="btn">start to put symbols</button>

<!-- 記号をつける場所 -->
<div id="english">
Please paste English sentences and click the button.<br>
Here is <a href="https://www.englishclub.com/reading/classic-reading.htm" target="_blank">an example of English texts</a>. 
</div>

</div>

<script>
// 履歴関連
let history = {
  currentSymbolNumber: 0,
  allActions: {
  },
  // method
  getCurrentSymbolNumber: function(){
    return this.currentSymbolNumber
  },  
  increaseCurrentSymbolNumber: function(){
    this.currentSymbolNumber += 1;    
  },
  decreaseCurrentSymbolNumber: function(){
    this.currentSymbolNumber -= 1;    
  },
  addCurrentToAllActions: function(){}
};

// ページ内の要素を削除する
function removeElements(){
    window.document.getElementById('english').innerText = window.document.getElementById('originalTxt').value;
    window.document.getElementById('originalTxt').value = "";
    window.document.getElementById('btn').remove();
    window.document.getElementById('originalTxt').remove();
}

// 原文を貼り付ける
window.btn.addEventListener('click', function(){removeElements();});

function clear(){
    // スタイルを削除する
    document.getElementById(`action${history.getCurrentSymbolNumber()-1}`).style = null;
    // 記号を削除する
    document.getElementById(`action${history.getCurrentSymbolNumber()-1}`).innerHTML = 
    document.getElementById(`action${history.getCurrentSymbolNumber()-1}`).innerHTML.replace("＜","").replace("＞","").replace(" )","").replace("( ","").replace("⤺","");
    // ルビを消す
    document.getElementById(`action${history.getCurrentSymbolNumber()-1}`).removeAttribute("data-ruby");
    // id を消す
    document.getElementById(`action${history.getCurrentSymbolNumber()-1}`).removeAttribute("id");
    // 操作ラベルを 1 減らす
    history.decreaseCurrentSymbolNumber();
}

document.addEventListener('keydown', (event) => {
  // Cmd(Ctrl)+z で直前の操作を取り消す
  if (event.key === 'z' && (event.ctrlKey || event.metaKey)) {
    clear();
  }
});

// 選択箇所の記号をクリアする
function clearSelected(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('style', ''); 
  newNode.innerHTML = selection.toString().replace("＜","").replace("＞","").replace(" )","").replace("( ","").replace("⤺","");
  range.deleteContents();
  range.insertNode(newNode);
  // 操作ラベルを 1 減らす
  history.decreaseCurrentSymbolNumber(); 
}

// 機能語の記号をつける
function alpha(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.setAttribute('style', 'border: solid 1px black;background-color: #fff0e0');
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  // 半角スペース '&thinsp;'
  newNode.innerHTML = selection.toString();
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();
}

// 主語の記号をつける
function s(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('style', 'border-bottom:3px double black;padding-bottom:2px;');
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.innerHTML = selection.toString();
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();
}

// 動詞の記号をつける
function v(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('style', 'border: solid 1px black;border-radius: 10px;');
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.innerHTML = selection.toString();
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();
}

// 目的語(O)・補語(C)の記号をつける
function oc(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('style', 'border-bottom:1px solid black;padding-bottom:2px;'); 
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.innerHTML = selection.toString();
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();
}

// 副詞の記号をつける
function adv(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');  
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  newNode.innerHTML = "＜"+selection.toString()+"＞";
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();

  console.log(newNode);
}

// 後置修飾の記号をつける
function adj(){
  let selection = window.getSelection();
  if(!selection.rangeCount) return; 
  let range = selection.getRangeAt(0);
  let newNode = document.createElement('span');
  newNode.setAttribute('id', `action${history.getCurrentSymbolNumber()}`);
  newNode.setAttribute('data-ruby', history.getCurrentSymbolNumber()+1);
  newNode.innerHTML = '<span style="display:inline-block;transform:scale(1.5, 1);">⤺</span>'+
    '( '+ 
    selection.toString()+' )';
  range.deleteContents();
  range.insertNode(newNode);

  // 履歴にタグと位置を入れる
  history.addCurrentToAllActions();
  // 操作のタグ番号を更新する
  history.increaseCurrentSymbolNumber();
}

// キー操作
document.addEventListener('keypress', (event) => {

    // 選択範囲がないときは return
    if(window.getSelection().toString() == '') return;

    // すでに記号がついているものを選択しているとき
    /*
    if(window.getSelection().toString() == window.getSelection().baseNode.nextSibling.innerText){ 
      history.currentSymbolNumber -= 1;
    }
    */

    // 記号付け
    let keyName = event.key;
    if (keyName == 'a'){
        s();
    }else if(keyName == 's'){
        v();
    }else if(keyName == 'd'){
        oc();
    }else if(keyName == 'f'){
        adv();
    }else if(keyName == 'g'){
        adj();
    }else if(keyName == 'z'){
        alpha();
    }else if(keyName == 'c'){
        clearSelected();
    }
});

// マウス選択操作
const element = document.querySelector("body");

element.addEventListener('selectstart', function(){
    element.addEventListener('mouseup', function(event) {
        // 半角スペースで始まるときは選択を打ち消す
        if(window.getSelection().toString().slice(0,1) == " "){
            window.getSelection().removeAllRanges();
        }

        // 選択が長すぎる場合は選択を取り消す
        if(window.getSelection().toString().length >= 80){
            window.getSelection().removeAllRanges();
        }

        // 最後が半角スペースで始まるときは選択を打ち消す
        if(window.getSelection().toString().slice(-1) == " "){
            console.log("!")
            window.getSelection().removeAllRanges();
        }
    });
});
</script>
</body>
